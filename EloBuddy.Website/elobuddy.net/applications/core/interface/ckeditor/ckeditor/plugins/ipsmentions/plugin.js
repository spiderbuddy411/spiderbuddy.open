CKEDITOR.plugins.add("ipsmentions",{init:function(c){new CKEDITOR.plugins.ipsmentions(c)}});
CKEDITOR.plugins.ipsmentions=function(c){this.currentMention=this.listenWithinMention=this.listenForAtSymbolEvent=null;this.callsWithNoResults=0;this.ajaxObj=this.results=null;this.listenForAtSymbol=function(){this.listenForAtSymbolEvent=c.on("change",function(a){CKEDITOR.tools.setTimeout(function(){var b=c.getSelection();if(b.getType()==CKEDITOR.SELECTION_TEXT)for(var b=b.getRanges(!0),a=0;a<b.length;a++)b[a].collapsed&&b[a].startOffset&&(b[a].setStart(b[a].startContainer,0),"@"==b[a].cloneContents().$.textContent.substr(-1)&&
this.respondToAtSymbol(b[a]))},0,this)},this)};this.respondToAtSymbol=function(a){var b=a.cloneContents().$.textContent;1<b.length&&!b.substr(-2,1).match(/\s/)||(this.listenForAtSymbolEvent.removeListener(),this.currentMention=new CKEDITOR.dom.element("span"),this.currentMention.setText("@"),b=a.endContainer.split(a.endOffset-1),b.split(1),this.currentMention.replace(b),b=c.createRange(),b.moveToPosition(this.currentMention,CKEDITOR.POSITION_BEFORE_END),c.getSelection().selectRanges([b]),this.callsWithNoResults=
0,this.results=$('\x3cul class\x3d"ipsMenu ipsMenu_auto ipsMenu_bottomLeft" data-mentionMenu\x3e\x3c/ul\x3e').hide(),this.results.append('\x3cli class\x3d"ipsLoading ipsLoading_small" style\x3d"height: 40px"\x3e\x26nbsp;\x3c/li\x3e'),$("body").append(this.results),b=$(this.currentMention.$).offset(),this.results.css({position:"absolute",top:b.top+a.getNextEditableNode().getSize("height")+8,left:b.left}),this.listenWithinMention=c.on("key",this.listenWithinMentionEvent,this))};this.listenWithinMentionEvent=
function(a){if(27==a.data.keyCode)this.cancelMention(),this.closeResults();else if(40==a.data.keyCode||38==a.data.keyCode){var b=this.results.children("[data-selected]");b.length?(b.removeAttr("data-selected"),40==a.data.keyCode?b.next().attr("data-selected",!0):b.prev().attr("data-selected",!0)):40==a.data.keyCode?this.results.children(":first-child").attr("data-selected",!0):this.results.children(":last-child").attr("data-selected",!0);a.cancel()}else 13==a.data.keyCode||9==a.data.keyCode?(b=this.results.children("[data-selected]"),
b.length&&b.click(),a.cancel()):(8==a.data.keyCode&&(this.callsWithNoResults=0),CKEDITOR.tools.setTimeout(function(){if(this.currentMention.getAddress().length){for(var a=c.getSelection().getRanges(),b=0;b<a.length;b++)if(!a[b].getCommonAncestor(!0,!0).equals(this.currentMention)){this.cancelMention();this.closeResults();return}var d=this.currentMention.getText().substr(1).trim();this.results.show();if(this.ajaxObj&&_.isFunction(this.ajaxObj.abort))try{this.ajaxObj.abort()}catch(e){}this.ajaxObj=
ips.getAjax()(c.config.controller+"\x26do\x3dmention\x26input\x3d"+encodeURIComponent(d),{context:this}).done(function(a){a?(this.results.removeClass("ipsLoading"),this.results.html(a),this.results.children().click($.proxy(this.selectMentionResult,this))):d.length&&(this.callsWithNoResults++,3<=this.callsWithNoResults&&(this.cancelMention(),this.closeResults()))})}else this.closeResults()},0,this))};this.selectMentionResult=function(a){a=$(a.currentTarget);this.currentMention.renameNode("a");this.currentMention.setAttribute("href",
a.attr("data-mentionhref"));this.currentMention.setAttribute("contenteditable","false");this.currentMention.setAttribute("data-ipsHover","");this.currentMention.setAttribute("data-ipsHover-target",a.attr("data-mentionhover"));this.currentMention.setAttribute("data-mentionid",a.attr("data-mentionid"));this.currentMention.setHtml("@"+a.find('[data-role\x3d"mentionname"]').html());c.focus();a=c.createRange();a.moveToElementEditEnd(this.currentMention);c.getSelection().selectRanges([a]);this.closeResults()};
this.cancelMention=function(){this.currentMention.remove(!0)};this.closeResults=function(){this.currentMention=null;this.results.remove();this.listenWithinMention.removeListener();this.listenForAtSymbol()};this.listenForAtSymbol()};